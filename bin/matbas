#!/usr/bin/env bash

# TODO: Replace this with something that removes the dependency on Bash.
# Perhaps a C or rust program?

# $0 is not exposed in node - process.argv is always
# ["node", "path/to/script", ...]. This exposes it in an environment variable.
# In a C++ version, we could probably use getenv/setenv for this.
export __MATBAS_DOLLAR_ZERO="${0}"

MATBAS_HOME="$(dirname "$(dirname "${BASH_SOURCE[0]}")")"
TELEMETRY="@matanuska/telemetry"
ENTRYPOINT="${MATBAS_HOME}/dist/main.js"

if [[ "${MATBAS_BUILD}" == 'debug' ]] && [ -n "${DEBUG_TRACE}" ]; then
  DEPRECATION_FLAG='--trace-deprecation'
else
  DEPRECATION_FLAG='--no-deprecation'
fi

exec node "${DEPRECATION_FLAG}" --enable-source-maps --require "${TELEMETRY}" "${ENTRYPOINT}" "$@"
