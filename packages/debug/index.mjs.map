{"version":3,"file":"index.mjs","sources":["index.ts"],"sourcesContent":["import { Attributes, context, Context, Span, SpanOptions, trace } from '@opentelemetry/api';\n\nexport type { Attributes, Context, Span, SpanOptions };\n\nconst tracer = trace.getTracer('main');\n\nexport { startSpan };\n\n// Very similar to OpenTelemetry's implementation of startActiveSpan, except\n// the callback function closes the span and attaches annotations in error\n// cases.\n//\n// This is currently defined regardless of whether or not we're in debug\n// mode, so that calling startSpan without a guard won't crash the program.\n// In practice, guards are placed at the call site.\n//\n// See: https://github.com/open-telemetry/opentelemetry-js/blob/main/api/src/trace/NoopTracer.ts#L56-L100\nfunction startSpan<F extends (span: Span) => ReturnType<F>>(\n  name: string,\n  fn: F\n): ReturnType<F>;\nfunction startSpan<F extends (span: Span) => ReturnType<F>>(\n  name: string,\n  opts: SpanOptions | undefined,\n  fn: F\n): ReturnType<F>;\nfunction startSpan<F extends (span: Span) => ReturnType<F>>(\n  name: string,\n  opts: SpanOptions | undefined,\n  ctx: Context | undefined,\n  fn: F\n): ReturnType<F>;\nfunction startSpan<F extends (span: Span) => ReturnType<F>>(\n  name: string,\n  arg2?: F | SpanOptions,\n  arg3?: F | Context,\n  arg4?: F\n): ReturnType<F> | undefined {\n  let opts: SpanOptions | undefined;\n  let ctx: Context | undefined;\n  let fn: F;\n  if (arguments.length < 2) {\n    return;\n  } else if (arguments.length === 2) {\n    fn = arg2 as F;\n  } else if (arguments.length === 3) {\n    opts = arg2 as SpanOptions | undefined;\n    fn = arg3 as F;\n  } else {\n    opts = arg2 as SpanOptions | undefined;\n    ctx = arg3 as Context | undefined;\n    fn = arg4 as F;\n  }\n  const wrapped = (span: Span) => {\n    try {\n      return fn(span);\n    } catch (err) {\n      span.recordException(err);\n  throw err;\n    } finally {\n      span.end();\n    }\n  }\n\n  const parentContext = ctx ?? context.active();\n  const span = tracer.startSpan(name, opts, parentContext);\n  const contextWithSpanSet = trace.setSpan(parentContext, span);\n  return context.with(contextWithSpanSet, wrapped, undefined, span);\n}\n\n// A convenience function for adding events when you don't have the span\n// immediately on-hand. Like startSpan, this is not hidden behind jscc and\n// should instead be conditionally imported/called at the site of use.\nexport function addEvent(message: string, attributes: Attributes = {}): void {\n  const span = trace.getActiveSpan();\n  if (span) {\n    span.addEvent(message, attributes);\n  }\n}\n"],"names":["tracer","trace","getTracer","startSpan","name","arg2","arg3","arg4","opts","ctx","fn","arguments","length","wrapped","span","err","recordException","end","parentContext","context","active","contextWithSpanSet","setSpan","with","undefined","addEvent","message","attributes","getActiveSpan"],"mappings":";;AAIA,MAAMA,MAAAA,GAASC,KAAAA,CAAMC,SAAS,CAAC,MAAA,CAAA;AA4B/B,SAASC,UACPC,IAAY,EACZC,IAAsB,EACtBC,IAAkB,EAClBC,IAAQ,EAAA;IAER,IAAIC,IAAAA;IACJ,IAAIC,GAAAA;IACJ,IAAIC,EAAAA;IACJ,IAAIC,SAAAA,CAAUC,MAAM,GAAG,CAAA,EAAG;AACxB,QAAA;AACF,IAAA,CAAA,MAAO,IAAID,SAAAA,CAAUC,MAAM,KAAK,CAAA,EAAG;QACjCF,EAAAA,GAAKL,IAAAA;AACP,IAAA,CAAA,MAAO,IAAIM,SAAAA,CAAUC,MAAM,KAAK,CAAA,EAAG;QACjCJ,IAAAA,GAAOH,IAAAA;QACPK,EAAAA,GAAKJ,IAAAA;IACP,CAAA,MAAO;QACLE,IAAAA,GAAOH,IAAAA;QACPI,GAAAA,GAAMH,IAAAA;QACNI,EAAAA,GAAKH,IAAAA;AACP,IAAA;AACA,IAAA,MAAMM,UAAU,CAACC,IAAAA,GAAAA;QACf,IAAI;AACF,YAAA,OAAOJ,EAAAA,CAAGI,IAAAA,CAAAA;AACZ,QAAA,CAAA,CAAE,OAAOC,GAAAA,EAAK;AACZD,YAAAA,IAAAA,CAAKE,eAAe,CAACD,GAAAA,CAAAA;YACzB,MAAMA,GAAAA;QACJ,CAAA,QAAU;AACRD,YAAAA,IAAAA,CAAKG,GAAG,EAAA;AACV,QAAA;AACF,IAAA,CAAA;AAEA,IAAA,MAAMC,aAAAA,GAAgBT,GAAAA,KAAAA,IAAAA,IAAAA,GAAAA,KAAAA,MAAAA,GAAAA,GAAAA,GAAOU,QAAQC,MAAM,EAAA;AAC3C,IAAA,MAAMN,IAAAA,GAAOd,MAAAA,CAAOG,SAAS,CAACC,MAAMI,IAAAA,EAAMU,aAAAA,CAAAA;AAC1C,IAAA,MAAMG,kBAAAA,GAAqBpB,KAAAA,CAAMqB,OAAO,CAACJ,aAAAA,EAAeJ,IAAAA,CAAAA;AACxD,IAAA,OAAOK,OAAAA,CAAQI,IAAI,CAACF,kBAAAA,EAAoBR,SAASW,SAAAA,EAAWV,IAAAA,CAAAA;AAC9D;AAEA;AACA;AACA;AACO,SAASW,QAAAA,CAASC,OAAe,EAAEC,UAAAA,GAAyB,EAAE,EAAA;IACnE,MAAMb,IAAAA,GAAOb,MAAM2B,aAAa,EAAA;AAChC,IAAA,IAAId,IAAAA,EAAM;QACRA,IAAAA,CAAKW,QAAQ,CAACC,OAAAA,EAASC,UAAAA,CAAAA;AACzB,IAAA;AACF;;;;"}